<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자의 여행 일정</title>
    <link th:href="@{/css/styles.css}" href="../css/styles.css" rel="stylesheet">
    <!-- 구글맵 스크립트 -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA53tcYEG1Lr9raR98hxk-8BEBecqPYJbE"></script>
</head>
<body>
    <header>
        <h1>여행 일정</h1>
    </header>

    <section id="map" style="height: 400px;"></section>

    <div class="container">
        <section id="trip-info">
            <table border="1">
                <thead>
                <tr>
                    <th align="left">여행 주제</th>
                    <th align="center">여행 기간</th>
                    <th align="center">상세 일정</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="item : ${list}">
                    <th th:onclick="storageDetail('[[${item.travelId}]]')" th:text="|${item.title}|">타이틀</th>
                    <th th:text="|${item.tripStart} ~ ${item.tripEnd}|">기간</th>
                    <th>
                        <button onclick="showDetails('[[${item.travelId}]]')">상세 보기</button>
                    </th>
                </tr>
                </tbody>
            </table>
        </section>

        <section id="details-container">
            <table border="1">
                <thead>
                <tr>
                    <th>시간</th>
                    <th>일정</th>
                    <th>날짜</th>
                </tr>
                </thead>
                <tbody id="details-content">
                <!-- JavaScript로 여기에 내용이 추가될 예정 -->
                </tbody>
            </table>
        </section>
    </div>

    <script>
        // 구글맵 초기화
        var map;
        function initMap() {
            var mapOptions = {
                center: {lat: 33.450701, lng: 126.570667}, // 지도의 중심좌표
                zoom: 8 // 지도의 확대 레벨
            };
            map = new google.maps.Map(document.getElementById('map'), mapOptions);
        }

        var markers = [];
        var routes = [];
        var polylines = [];

        function storageDetail(travelId) {
            fetch('/storage/' + travelId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                console.log('성공:', data);
                resetMap();
                routes = data;
                displaySavedRoutes();
                showDetails(travelId);
            })
            .catch(error => {
                console.error('오류:', error);
                alert('경로 저장 중 오류가 발생했습니다.');
            });
        }

        function addMarker(position, num) {
            var marker = new google.maps.Marker({
                position: position,
                map: map,
                label: num.toString() // 마커에 번호 표시
            });
            markers.push(marker);
        }

        function displaySavedRoutes() {
            routes.forEach((route, index) => {
                if (route.latitude && route.longitude) {
                    var position = {lat: route.latitude, lng: route.longitude};
                    addMarker(position, route.travelSq);
                }
            });

            for (var i = 1; i < routes.length; i++) {
                if (routes[i-1].latitude && routes[i-1].longitude) {
                    var start = {lat: routes[i - 1].latitude, lng: routes[i - 1].longitude};
                    var end = {lat: routes[i].latitude, lng: routes[i].longitude};

                    var polyline = new google.maps.Polyline({
                        path: [start, end],
                        geodesic: true,
                        strokeColor: '#FF0000',
                        strokeOpacity: 1.0,
                        strokeWeight: 2
                    });
                    polyline.setMap(map);
                    polylines.push(polyline);
                }
            }

            var lastPosition = {lat: routes[routes.length - 1].latitude, lng: routes[routes.length - 1].longitude};
            map.setCenter(lastPosition);
        }

        function resetMap() {
            routes = [];
            markers.forEach(marker => marker.setMap(null));
            markers = [];
            polylines.forEach(polyline => polyline.setMap(null));
            polylines = [];
        }

        function showDetails(travelId) {
            var detailsContent = document.getElementById('details-content');
            detailsContent.innerHTML = ''; // 기존 내용을 초기화

            routes.forEach((route) => {
                var row = document.createElement('tr');

                var timeCell = document.createElement('td');
                timeCell.textContent = '시간 정보';
                row.appendChild(timeCell);

                var contentCell = document.createElement('td');
                contentCell.textContent = '일정 정보';
                row.appendChild(contentCell);

                var dateCell = document.createElement('td');
                dateCell.textContent = route.dayTrip;
                row.appendChild(dateCell);

                detailsContent.appendChild(row);
            });

            document.getElementById('details-container').style.display = 'block';
        }

        // 맵 초기화 호출
        initMap();
    </script>
</body>
</html>
